<!DOCTYPE html><html lang="th"><head>
<meta charset="utf-8"><title>‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</title><link rel="stylesheet" href="style.css">
</head><body>
<div class="nav"><div class="brand"><i>‚óâ</i>ClearKhong</div><div class="row"><a href="notifications.html">üîî</a><a href="home.html">Home</a><button id="logout" class="btn-secondary">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button></div></div>
<div class="container">
  <div class="card" id="box"></div>
  <div class="card">
    <div class="row" style="margin-bottom:10px">
      <h3 style="margin:0">Pending</h3>
      <span class="spacer"></span>
    </div>
    <div id="pendingBox"></div>
  </div>
  <div class="card">
    <div class="row" style="margin-bottom:10px">
      <h3 style="margin:0">History</h3>
      <span class="spacer"></span>
      <select id="filter">
        <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
        <option value="myposts">‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</option>
        <option value="buys">‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠</option>
        <option value="trades">‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î</option>
      </select>
    </div>
    <div id="history"></div>
  </div>
</div>
<script type="module">
import {api,toast,qs,bust,API,logout} from './js/common.js';
document.getElementById('logout').onclick=logout;
const box=qs('#box'), hbox=qs('#history');
const params=new URL(location.href).searchParams;
const viewId = params.get('id') || params.get('user');
let me=null; let viewingOther=false; let current=null;
function viewImage(url){ return (url ? (API + url) : 'https://www.pngall.com/wp-content/uploads/5/Profile-PNG-File.png'); }
async function load(){
  me = await api('/api/profile/me').catch(()=>null);
  if(!me){ window.__guest = true; /* ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î Guest: ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß */ }
  
  if(viewId && (!me || me.role!=='admin')){
    viewingOther = true;
    try{
      const r = await api('/api/profile/public/'+viewId);
      current = r.user;
      // Render readonly profile (no edit, no tokens controls)
      renderPublicProfile(r.user, r.recentPosts||[]);
    }catch(e){
      // fallback: show not found
      current = { username: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ', profile_image_url: '' };
      renderPublicProfile(current, []);
    }
    return;
  }

if(viewId && me.role==='admin'){
    viewingOther = true;
    current = await api('/api/admin/users/'+viewId);
    try{
      const hist = await api('/api/admin/users/'+viewId+'/history');
      renderProfile(false);
  renderHistory(hist);
  renderPending(hist.myPosts);
    }catch(e){
      renderProfile(false);
  renderHistory(hist);
  renderPending(hist.myPosts);
    }
  }else{
    current = await api('/api/profile/me');
    const hist = await api('/api/profile/history');
    renderProfile(false);
  renderHistory(hist);
  renderPending(hist.myPosts);
  }
}

function renderPublicProfile(user, recentPosts){
  const img = viewImage(user.profile_image_url);
  box.innerHTML = `<div class="row">
    <img class="avatar" src="${bust(img)}">
    <div style="min-width:260px">
      <div style="font-size:20px"><b>${user.username}</b></div>
      <div>‡∏£‡πâ‡∏≤‡∏ô: ${user.shop_name || '-'}</div>
      <div>‡πÄ‡∏ö‡∏≠‡∏£‡πå: ${user.phone || '-'}</div>
      <div>‡∏≠‡∏µ‡πÄ‡∏°‡∏•: ${user.email || '-'}</div>
      <div>Bio: ${user.bio || '-'}</div>
    </div>
    <span class="spacer"></span>
    <span class="badge">Public</span>
    <a class="btn-secondary" style="margin-left:10px" href="report.html?target=${user.id}">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ</a>
  </div>
  <div style="margin-top:10px">
    <h3 style="margin:0 0 8px 0">‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
    <div id="recentBox"></div>
  </div>`;

  const rBox = document.getElementById('recentBox');
  if(!recentPosts || !recentPosts.length){
    rBox.innerHTML = '<div style="opacity:.7">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏û‡∏™‡∏ï‡πå</div>';
  }else{
    rBox.innerHTML = recentPosts.map(p => (
      `<div class="post-row">
        <a href="post.html?id=${p.id}"><b>${p.title||'(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠)'}</b></a>
        <span class="badge ${p.status==='approved'?'ok':(p.status==='pending'?'warn':'err')}">${p.status}</span>
        <span style="opacity:.6;margin-left:8px">${new Date(p.created_at).toLocaleString()}</span>
      </div>`
    )).join('');
  }
}

function renderProfile(editing){
  
  const img=viewImage(current.profile_image_url);
  box.innerHTML=`<div class="row">
    <img id="avatar" class="avatar" src="${bust(img)}" title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ">
    <input id="file" type="file" accept="image/*" style="display:none">
    <div style="min-width:260px">
      <div style="font-size:20px"><b>${current.username}</b></div>
      <div>Tokens: <b id="bal">${current.tokens}</b> <button id="add" class="btn-secondary">Ôºã</button></div>
      <div>‡∏£‡πâ‡∏≤‡∏ô: ${editing?`<input id="shopName" value="${current.shop_name||''}" style="width:100%">`:(current.shop_name||'-')}</div>
      <div>‡πÄ‡∏ö‡∏≠‡∏£‡πå: ${editing?`<input id="phone" value="${current.phone||''}" style="width:100%">`:(current.phone||'-')}</div>
      <div>‡∏≠‡∏µ‡πÄ‡∏°‡∏•: ${editing?`<input id="email" value="${current.email||''}" style="width:100%">`:(current.email||'-')}</div>
      <div>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà: ${editing?`<input id="address" value="${current.address||''}" style="width:100%">`:(current.address||'-')}</div>
      <div>Bio: ${editing?`<textarea id="bio" style="width:100%;height:70px">${current.bio||''}</textarea>`:(current.bio||'-')}</div>
    </div>
    <span class="spacer"></span>
    ${editing?`<button id="cancel" class="btn-secondary">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button id="save">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>`:`<button id="edit" class="btn-secondary">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>`}
  </div>`;
  const avatar=qs('#avatar'); const file=qs('#file'); avatar.onclick=()=>file.click();
  file.onchange=async (e)=>{ const f=e.target.files?.[0]; 
  if(!f) return; avatar.src=URL.createObjectURL(f);
  const fd=new FormData(); fd.append('profileImage',f);
    try{ const r=await api(viewId?('/api/admin/users/'+viewId):'/api/profile/me',{method:'PUT',body:fd}); current=r;
    avatar.src=bust(viewImage(r.profile_image_url)); 
    toast('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏•‡πâ‡∏ß','ok'); 
  } catch(err){ toast(err,'err'); avatar.src=bust(img); } };
  const editBtn=qs('#edit'), saveBtn=qs('#save'), cancelBtn=qs('#cancel'); 
  if(editBtn) 
  editBtn.onclick=()=>renderProfile(true);
  if(saveBtn) saveBtn.onclick=async ()=>{
  const email = qs('#email')?.value?.trim() || '';
  const phone = qs('#phone')?.value?.trim() || '';
  if(email && !email.includes('@')) { toast('‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ @','err'); return; }
  if(phone && !/^\d{10}$/.test(phone)) { toast('‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 10 ‡∏´‡∏•‡∏±‡∏Å','err'); return; }
  const fd = new FormData();
  const pf = qs('#file')?.files?.[0];
  if(pf) fd.append('profileImage', pf);
  const sn = qs('#shopName')?.value?.trim() || '';
  fd.append('shopName', sn);
  fd.append('phone', phone);
  fd.append('email', email);
  const address = (qs('#address')?.value?.trim() || '');
  const bio = (qs('#bio')?.value?.trim() || '');
  fd.append('address', address);
  fd.append('bio', bio);
  const target = (viewId?('/api/admin/users/'+viewId):'/api/profile/me');
  try{
    const r = await api(target, { method:'PUT', body: fd });
    current = r;
    toast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß','ok');
    renderProfile(false);
  }catch(err){ toast(err,'err'); }
};
if(cancelBtn) cancelBtn.onclick=()=>renderProfile(false);
  qs('#add').onclick=()=>location.href='topup.html';
}

function renderPending(allMyPosts){
  const box = document.getElementById('pendingBox');
  if(!box) return;
  const rows = (allMyPosts||[]).filter(p=>p.status==='pending' || p.status==='rejected' || p.status==='waiting');
  if(!rows.length){ box.innerHTML='<div style="opacity:.7">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</div>'; return; }
  box.innerHTML = rows.map(p=>{
    const actions = p.status==='waiting' 
      ? `<button class="mini primary" data-act="publish" data-id="${p.id}">‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÄ‡∏•‡∏¢ (‡∏´‡∏±‡∏Å 10)</button> <button class="mini" data-act="del" data-id="${p.id}">‡∏•‡∏ö</button>`
      : (p.status==='pending' 
          ? `<button class="mini" data-act="del" data-id="${p.id}">‡∏•‡∏ö</button>`
          : `<button class="mini" data-act="edit" data-id="${p.id}">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button> <button class="mini" data-act="resubmit" data-id="${p.id}">‡∏™‡πà‡∏á‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏´‡∏°‡πà</button> <button class="mini" data-act="del" data-id="${p.id}">‡∏•‡∏ö</button>`);
    const cls = p.status==='rejected'?'err':(p.status==='waiting'?'warn':'ok');
    return `<div class="row" style="margin:6px 0">
      <a class="spacer" href="post.html?id=${p.id}"><b>${p.title}</b></a>
      <span class="badge ${cls}">${p.status}</span> ${actions}
    </div>`;
  }).join('');
}
document.addEventListener('click', async (e)=>{
  const act = e.target?.dataset?.act;
  if(!act) return;
  const id = e.target.dataset.id;
  if(act==='publish'){
    try{ const r=await api('/api/posts/'+id+'/publish',{method:'POST'}); toast('‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà‡πÅ‡∏•‡πâ‡∏ß','ok'); location.reload(); }catch(err){ toast(err,'err'); }
  }else if(act==='del'){
    if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏ô‡∏µ‡πâ?')) return;
    try{ await api('/api/posts/'+id,{method:'DELETE'}); toast('‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß','ok'); location.reload(); }catch(err){ toast(err,'err'); }
  }else if(act==='resubmit'){
    try{ await api('/api/posts/'+id+'/resubmit',{method:'POST'}); toast('‡∏™‡πà‡∏á‡∏ï‡∏£‡∏ß‡∏à‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß','ok'); location.reload(); }catch(err){ toast(err,'err'); }
  }else if(act==='edit'){
    // ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏á‡πà‡∏≤‡∏¢‡πÜ‡πÑ‡∏õ‡∏ó‡∏µ‡πà post.html ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏Å‡πâ‡∏ï‡πà‡∏≤‡∏á‡∏´‡∏≤‡∏Å‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô) ‚Äî ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡∏Ç‡∏≠‡πÄ‡∏î‡πâ‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï
    location.href='edit.html?id='+id;
  }
});

function renderHistory(hist){
  const t=document.getElementById('filter').value; let rows=[]; if(t==='all') rows=[...hist.myPosts,...hist.myBuys]; if(t==='myposts') rows=hist.myPosts; if(t==='buys') rows=hist.myBuys; if(t==='trades') rows=hist.myTrades; if(t==='all') rows=[...(hist.myPosts||[]),...(hist.myBuys||[]),...(hist.myTrades||[])]; if(t==='trades') rows=hist.myTrades;
  hbox.innerHTML = rows.map(r=>{ if(r.title){ const cls=r.status==='closed'?'ok':(r.status==='pending'?'warn':(r.status==='rejected'?'err':''));
    return `<div class="row" style="margin:6px 0"><a class="spacer" href="post.html?id=${r.post_id||r.id}"><b>${r.title}</b></a><span class="badge ${cls}">${r.status}</span></div>`; }
    return `<div class="row" style="margin:6px 0">‡∏ã‡∏∑‡πâ‡∏≠‡πÇ‡∏û‡∏™‡∏ï‡πå #${r.post_id} <span class="spacer"></span> <span class="badge ok">${r.status}</span></div>`; }).join('');
}
document.getElementById('filter').onchange=()=>load();
load();
</script>

<script type="module">
import { api, qs, qsa, toast } from './js/common.js';

async function setupGuestUI(){
  let me = await api('/api/profile/me').catch(()=>null);
  if(!me){
    // Nav: change "‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö" -> "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö"
    const logoutBtn = document.getElementById('logout');
    if(logoutBtn){
      logoutBtn.textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
      logoutBtn.classList.remove('btn-secondary');
      logoutBtn.onclick = ()=> location.href='login.html';
    }
    const adminLink = document.getElementById('adminLink');
    if(adminLink) adminLink.style.display='none';
    const bal = document.getElementById('balNav');
    if(bal){ bal.textContent='Guest'; bal.removeAttribute('title'); bal.onclick=null; }

    // Profile page restrictions
    // Hide or disable editing elements
    ['edit','save','cancel','file'].forEach(id=>{ const el=qs('#'+id); if(el){ el.style.display='none'; el.disabled=true; }});
    qsa('button').forEach(btn=>{
      if(btn && /‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç|‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å|‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î|save|edit|upload/i.test(btn.textContent||'')){
        btn.disabled = true;
        btn.style.opacity = .6;
        btn.onclick = (e)=>{ e.preventDefault(); toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ login','err'); };
      }
    });
  }
}
setupGuestUI();
</script>


<script type="module">
import { api, qs, qsa, toast } from './js/common.js';

async function setupGuestUI(){
  let me = await api('/api/profile/me').catch(()=>null);
  if(!me){
    // Nav: change "‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö" -> "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö"
    const logoutBtn = document.getElementById('logout');
    if(logoutBtn){
      logoutBtn.textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
      logoutBtn.classList.remove('btn-secondary');
      logoutBtn.onclick = ()=> location.href='login.html';
    }
    const adminLink = document.getElementById('adminLink');
    if(adminLink) adminLink.style.display='none';
    const bal = document.getElementById('balNav');
    if(bal){ bal.textContent='Guest'; bal.removeAttribute('title'); bal.onclick=null; }

    // Render a simple read-only Guest profile so the page isn't empty
    const box = qs('#box');
    if(box){
      box.innerHTML = `
        <div class="row">
          <img id="avatar" src="https://www.pngall.com/wp-content/uploads/5/Profile-PNG-File.png" alt="Guest" style="width:80px;height:80px;border-radius:50%;object-fit:cover;margin-right:12px">
          <div>
            <h3 style="margin:0">Guest</h3>
            <div class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</div>
          </div>
          <span class="spacer"></span>
          <button class="btn-primary" onclick="location.href='login.html'">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
      `;
    }

    // Profile page restrictions
    ['edit','save','cancel','file'].forEach(id=>{ const el=qs('#'+id); if(el){ el.style.display='none'; el.disabled=true; }});
    qsa('button').forEach(btn=>{
      if(btn && /‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç|‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å|‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î|save|edit|upload/i.test(btn.textContent||'')){
        btn.disabled = true;
        btn.style.opacity = .6;
        btn.onclick = (e)=>{ e.preventDefault(); toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ login','err'); };
      }
    });
  }
}
setupGuestUI();
</script>

</body></html>
